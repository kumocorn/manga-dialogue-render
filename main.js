/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var A=Object.create;var m=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty;var B=(o,s)=>{for(var t in s)m(o,t,{get:s[t],enumerable:!0})},T=(o,s,t,a)=>{if(s&&typeof s=="object"||typeof s=="function")for(let e of k(s))!I.call(o,e)&&e!==t&&m(o,e,{get:()=>s[e],enumerable:!(a=D(s,e))||a.enumerable});return o};var N=(o,s,t)=>(t=o!=null?A(H(o)):{},T(s||!o||!o.__esModule?m(t,"default",{value:o,enumerable:!0}):t,o)),R=o=>T(m({},"__esModule",{value:!0}),o);var j={};B(j,{default:()=>S});module.exports=R(j);var P=require("obsidian");var x=N(require("path"));function f(o,s,t,a=!0){let e=`skin/${t}`;return a?Promise.resolve(o.vault.adapter.getResourcePath(`${s.dir}/${e}`)):Promise.resolve(x.join(".obsidian","plugins",s.id,e))}async function v(o,s,t,a=!1){let e=await t.generateCustomStyles();await V(o,s,"color.css",e),a&&await u(o,s,"color.css")}async function L(o,s,t){await u(o,s,"color.css"),t.id="dialogue-custom-style"}async function V(o,s,t,a){let e=await f(o,s,t,!1);try{let r=e.substring(0,e.lastIndexOf("/"));await o.vault.adapter.exists(r)||await o.vault.adapter.mkdir(r),await o.vault.adapter.write(e,a)}catch(r){console.error(`Failed to save ${t}:`,r)}}async function u(o,s,t){let a=await f(o,s,t,!0);try{let e=await fetch(a,{cache:"no-store"});if(!e.ok){console.error(`Failed to load ${t}:`,e.statusText);return}let r=await e.text(),n=document.querySelector(`style[data-filename="${t}"]`);n||(n=document.createElement("style"),n.setAttribute("data-filename",t),document.head.appendChild(n)),n.textContent=r}catch(e){console.error(`Failed to fetch ${t}:`,e)}}var C=class{constructor(s,t,a){this.app=s,this.settings=t,this.manifest=a}async loadTemplate(){let s=await f(this.app,this.manifest,"_color.tpl",!0);try{let t=await fetch(s);return t.ok?await t.text():""}catch(t){return console.error("Error loading template:",t),""}}generateCharacterCss(s){let t=new Set,a=`:root {
`,e="";return this.settings.characters.forEach(r=>{if(t.has(r.id))return;t.add(r.id);let{varName:n,variable:i}=this.generateColorVariable(r,!1);a+=`  ${n}: ${i}
`,e+=this.createCustomCss(r,s)}),{rootCss:a,customCss:e}}createCustomCss(s,t){return t.replace(/{{id}}/g,s.id).replace(/{{name}}/g,s.name)}async generateCustomStyles(){let s=await this.loadTemplate();if(!s)return console.warn("Template is empty or could not be loaded."),"";let{rootCss:t,customCss:a}=this.generateCharacterCss(s);return`${t}}
${a}`}generateColorVariable(s,t){let a=`--characterID-${s.id}-color`,e=t?`${s.color} !important`:s.color,r=`/* ${s.name} */`,n=`${e}; ${r}`;return{varName:a,variable:n}}applyCustomStyles(s){let t=this.settings,a=document.getElementById("dialogue-custom-style");a||(a=document.createElement("style"),a.id="dialogue-custom-style",document.head.appendChild(a));let e=(c,l)=>l&&l.trim()!==""?`${c}: ${l};`:"",r=c=>`"${c}"`,n=`
    
     /* Appearance */
    ${[e("--m-d-serihu-text-color",t.textColor),e("--m-d-serihu-background",t.backgroundColor),e("--m-d-serihu-border",t.borderColor),e("--m-d-bubble-height",t.bubbleHeight),e("--m-d-comment-width",t.commentWidth)].filter(Boolean).join(`
    `)}  

  /* Font */
    --dialogue-font: ${r(t.defaultFont||"Shippori Antique")};
    --monologue-font: ${r(t.monologueFont||"\u6E90\u67D4\u30B4\u30B7\u30C3\u30AF")};
    --pop-font: ${r(t.popFont||"Mochiy Pop One")};
    --strong-font: ${r(t.strongFont||"\u6E90\u668E\u30A8\u30E0\u30B4v2")};
    --weak-font: ${r(t.weakFont||"851\u30C1\u30AB\u30E9\u30E8\u30EF\u30AF")};
    --horror-font: ${r(t.horrorFont||"g_\u30B3\u30DF\u30C3\u30AF\u30DB\u30E9\u30FC\u6050\u6016-\u6559\u6F22")};

  /* Characters */
  `.trim(),h=(s&&s.length>0?s:this.settings.characters).map(c=>`  --characterID-${c.id}-color: ${c.color} !important; /* ${c.name} */`).join(`
  `);a.textContent=`:root {
  ${n}
  ${h}
}`}updateCharacterColor(s){let t=document.getElementById("dialogue-custom-style");t||(t=document.createElement("style"),t.id="dialogue-custom-style",document.head.appendChild(t));let e=(t.textContent||"").match(/:root\s*{([\s\S]*?)}/),n=(e?e[1].trim():"").match(/--characterID-[\w-]+-color:\s*#[\da-fA-F]+ !important;\s*\/\*.*?\*\//g)||[],i={};n.forEach(c=>{let l=c.match(/--characterID-([\w-]+)-color:/);if(l){let d=l[1];i[d]=c}}),s.forEach(c=>{let l=c.color;i[c.id]=`--characterID-${c.id}-color: ${l} !important; /* ${c.name} */`});let h=Object.values(i).join(`
  `);t.textContent=`:root {
  ${h}
}`}};var g=require("obsidian");var w="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var E=(o=21)=>{let s="",t=crypto.getRandomValues(new Uint8Array(o|=0));for(;o--;)s+=w[t[o]&63];return s};var y=class extends g.PluginSettingTab{constructor(t,a,e){super(t,a);this.plugin=a,this.manifest=e,this.generalSettingsContainer=document.createElement("div"),this.characterListContainer=document.createElement("div")}display(){let{containerEl:t}=this;t.empty();let{generalSettingsContainer:a,characterListContainer:e}=this.createTabs(t);this.createGeneralSettingsTab(a),this.createCharacterListTab(e)}createTabs(t){let a=t.createDiv(),e=a.createEl("button",{text:"General Settings"}),r=a.createEl("button",{text:"Character List"});e.classList.add("tab-button"),r.classList.add("tab-button");let n=t.createDiv(),i=t.createDiv();return n.addClass("tab-content"),i.addClass("tab-content"),n.style.display="block",i.style.display="none",e.addEventListener("click",()=>this.switchTab(n,i,e,r)),r.addEventListener("click",()=>this.switchTab(i,n,r,e)),a.appendChild(e),a.appendChild(r),e.classList.add("active"),{generalSettingsContainer:n,characterListContainer:i}}switchTab(t,a,e,r){t.style.display="block",a.style.display="none",e.classList.add("active"),r.classList.remove("active")}createDescFragment(t,a){let e=document.createDocumentFragment();return e.append(t,e.createEl("br"),a),e}createGeneralSettingsTab(t){t.empty(),t.createEl("h2",{text:"Appearance"}),this.addSetting("Text Color","Sets the color of the text.","\u6587\u5B57\u306E\u8272\u3092\u8A2D\u5B9A\u3057\u307E\u3059\u3002","color","textColor","#202020",t),this.addSetting("Bubble Background Color","Sets the background color of the speech bubble.","\u5439\u304D\u51FA\u3057\u306E\u80CC\u666F\u8272\u3092\u8A2D\u5B9A\u3057\u307E\u3059\u3002","color","backgroundColor","#faf5f0",t),this.addSetting("Bubble Border Color","Sets the border color of the speech bubble.","\u5439\u304D\u51FA\u3057\u306E\u67A0\u7DDA\u306E\u8272\u3092\u8A2D\u5B9A\u3057\u307E\u3059\u3002","color","borderColor","#000000",t),this.addSetting("Bubble height","Sets the maximum height of speech bubbles.","\u5439\u304D\u51FA\u3057\u306E\u6700\u5927\u306E\u9AD8\u3055\u3092\u5909\u66F4\u3057\u307E\u3059\u3002","text","bubbleHeight","12em",t),this.addSetting("Comment width","Sets the maximum width of the comment area.","\u30B3\u30E1\u30F3\u30C8\u30A8\u30EA\u30A2\u306E\u6700\u5927\u306E\u5E45\u3092\u5909\u66F4\u3057\u307E\u3059\u3002","text","commentWidth","60%",t),t.createEl("h2",{text:"Font"}),this.addSetting("Typeface for nomal font.","Specifies the normal dialogue font.","\u901A\u5E38\u306E\u53F0\u8A5E\u30D5\u30A9\u30F3\u30C8\u3092\u6307\u5B9A\u3057\u307E\u3059\u3002","text","defaultFont","\u6E90\u668E\u30A2\u30F3\u30C1\u30C3\u30AF v5",t),this.addSetting("Typeface for :monologue","Specifies the font for monologue dialogue.","\u30E2\u30CE\u30ED\u30FC\u30B0\u7528\u306E\u30D5\u30A9\u30F3\u30C8\u3092\u6307\u5B9A\u3057\u307E\u3059\u3002","text","monologueFont","\u6E90\u67D4\u30B4\u30B7\u30C3\u30AF",t),this.addSetting("Typeface for :pop","Specifies the font for pop-style dialogue.","\u30DD\u30C3\u30D7\u7CFB\u306E\u53F0\u8A5E\u306B\u4F7F\u7528\u3059\u308B\u30D5\u30A9\u30F3\u30C8\u3092\u6307\u5B9A\u3057\u307E\u3059\u3002","text","popFont","Mochiy Pop One",t),this.addSetting("Typeface for :strong","Specifies the font for strong dialogue.","\u529B\u5F37\u3044\u53F0\u8A5E\u306B\u4F7F\u7528\u3059\u308B\u30D5\u30A9\u30F3\u30C8\u3092\u6307\u5B9A\u3057\u307E\u3059\u3002","text","strongFont","\u6E90\u668E\u30A8\u30E0\u30B4v2",t),this.addSetting("Typeface for :weak","Specifies the font for weak voice dialogue.","\u5F31\u3005\u3057\u3044\u53F0\u8A5E\u306B\u4F7F\u7528\u3059\u308B\u30D5\u30A9\u30F3\u30C8\u3092\u6307\u5B9A\u3057\u307E\u3059\u3002","text","weakFont","851\u30C1\u30AB\u30E9\u30E8\u30EF\u30AF",t),this.addSetting("Typeface for :horror","Specifies the font for horror dialogue.","\u30DB\u30E9\u30FC\u7CFB\u306E\u53F0\u8A5E\u306B\u4F7F\u7528\u3059\u308B\u30D5\u30A9\u30F3\u30C8\u3092\u6307\u5B9A\u3057\u307E\u3059\u3002","text","horrorFont","g_\u30B3\u30DF\u30C3\u30AF\u30DB\u30E9\u30FC\u6050\u6016-\u6559\u6F22",t)}addSetting(t,a,e,r,n,i,h){let c=new g.Setting(h).setName(t).setDesc(this.createDescFragment(a,e));r==="color"?c.addColorPicker(l=>l.setValue(this.plugin.settings[n]||i).onChange(async d=>{this.plugin.settings[n]=d,await this.batchSaveSettings()})).addButton(l=>l.setIcon("rotate-ccw").setTooltip("Reset to Default Color").onClick(async()=>{this.plugin.settings[n]=i,await this.batchSaveSettings(),this.display()})):r==="text"&&c.addText(l=>l.setPlaceholder(`ex: ${i}`).setValue(this.plugin.settings[n]||"").onChange(async d=>{this.plugin.settings[n]=d,await this.batchSaveSettings()}))}createCharacterListTab(t){t.empty(),this.createCharacterInput(t),t.createDiv().createEl("h2",{text:"Character List"}),this.createCharacterList(t)}createCharacterInput(t){let a="",e;new g.Setting(t).setName("Add New Character").setDesc(this.createDescFragment("Type character name and press add button. You can set the character color.","\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u540D\u3092\u5165\u529B\u3057\u3066\u8FFD\u52A0\u30DC\u30BF\u30F3\u3092\u62BC\u3057\u3066\u304F\u3060\u3055\u3044\u3002\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u30AB\u30E9\u30FC\u3092\u8A2D\u5B9A\u3067\u304D\u307E\u3059\u3002")).addText(r=>{e=r,r.setPlaceholder("New Character Name").onChange(n=>a=n)}).addButton(r=>r.setIcon("user-plus").setTooltip("Add character").onClick(async()=>{if(a.trim()===""||this.plugin.settings.characters.some(i=>i.name===a))return;let n=`${E(6)}`;this.plugin.settings.characters.push({name:a,color:"#ffffff",id:n}),await this.batchSaveSettings(),e.setValue(""),u(this.app,this.manifest,"color.css"),console.log("css\u3092\u518D\u8AAD\u8FBC\u3057\u307E\u3057\u305F"),this.createCharacterListTab(t)}))}createCharacterList(t){this.plugin.settings.characters.forEach((a,e)=>{this.createCharacterSetting(t,a,e)})}createCharacterSetting(t,a,e){let r=new g.Setting(t),n=r.nameEl.createEl("span",{text:a.name});r.addColorPicker(c=>c.setValue(a.color).onChange(async l=>{this.plugin.settings.characters[e].color!==l&&(this.plugin.settings.characters[e].color=l,this.plugin.styleManager.updateCharacterColor([this.plugin.settings.characters[e]]),await this.batchSaveSettings())}));let i=new g.TextComponent(r.controlEl);i.inputEl.style.display="none";let h=new g.ButtonComponent(r.controlEl).setIcon("pencil").setTooltip("Edit Name").onClick(()=>{if(i.inputEl.style.display==="none")n.style.display="none",i.inputEl.style.display="",i.setValue(n.textContent||""),h.setIcon("check").setTooltip("Confirm!");else{let c=i.getValue().trim();c!==""&&(n.textContent=c,this.plugin.settings.characters[e].name=c,this.batchSaveSettings()),i.inputEl.style.display="none",n.style.display="",h.setIcon("pencil").setTooltip("Edit Name")}});r.addButton(c=>c.setIcon("user-round-x").setTooltip("Remove Character").setWarning().onClick(async()=>{this.plugin.settings.characters.splice(e,1),await this.batchSaveSettings(),u(this.app,this.manifest,"color.css"),this.createCharacterListTab(t)}))}async batchSaveSettings(){await this.plugin.saveSettings();let t=this.plugin.settings.characters.filter(a=>a.color);this.plugin.styleManager.applyCustomStyles(t)}};var M={textColor:"#202020",backgroundColor:"#faf5f0",borderColor:"#000000",bubbleHeight:"12em",commentWidth:"60%",defaultFont:"",monologueFont:"",popFont:"",strongFont:"",weakFont:"",horrorFont:"",characters:[]};var b=class{constructor(s,t,a){this.plugin=s,this.settings=s.settings,this.source=t,this.el=a,this.render()}render(){let s=document.createElement("div");s.classList.add("serihu-container");let t="",a="",e="",r=null;this.source.split(`
`).forEach(n=>{if(n.trim()==="")return;if(n.trim().startsWith("# ")){this.renderComment(n,s),r=null;return}let i=n.match(/^(left|right):\s*(.*)$/);if(i){[t,a]=this.updateCharacter(i,t,a);return}let h=this.parseDialogue(n);if(!h)return;let{position:c,bubbleTypeClass:l,fontType:d,dialogue:$}=h,p=c==="right"?a:t,F=this.getCharacterID(p);r=this.getOrCreateCharacterContainer(s,r,p,e,c,F),this.createBubble(r,p,$,d,l,e),e=p}),this.el.appendChild(s)}renderComment(s,t){let a=s.trim().substring(1).trim(),e=document.createElement("div");e.classList.add("serihu-comment");let r=document.createElement("div");r.classList.add("serihu-comment-text"),r.textContent=a,e.appendChild(r),t.appendChild(e)}updateCharacter(s,t,a){let[,e,r]=s;return e==="left"?[r,a]:[t,r]}parseDialogue(s){let t=s.match(/^([<>]{1,2}|\(\(|\)\)|\(|\))\s*(?::([a-zA-Z0-9_-]+))?\s(.+)$/);if(!t)return null;let[,a,e,r]=t,n=this.getPositionFromPrefix(a),i=this.getBubbleTypeClass(a);return{position:n,bubbleTypeClass:i,fontType:e,dialogue:r}}getPositionFromPrefix(s){switch(s){case">":case">>":case")":case"))":return"right";default:return"left"}}getBubbleTypeClass(s){switch(s){case"<<":case">>":return"rough";case"(":case")":return"thought";case"((":case"))":return"uniflash";default:return""}}getOrCreateCharacterContainer(s,t,a,e,r,n){if(t&&a===e)return t;let i=document.createElement("div");return i.classList.add(`character-container-${r}`),n&&i.classList.add(`characterID-${n}`),s.appendChild(i),i}createBubble(s,t,a,e,r,n){let i=document.createElement("div");i.classList.add("serihu-bubble",s.classList.contains("character-container-right")?"right":"left"),r&&i.classList.add(r),t!==n&&(()=>{let c=document.createElement("div");c.classList.add("serihu-char"),c.textContent=t,i.appendChild(c)})();let h=document.createElement("div");h.classList.add("serihu-text"),e&&h.classList.add(`type-${e}`),h.textContent=a,i.appendChild(h),s.appendChild(i)}updateCharacterClasses(){document.querySelectorAll("[class^='character-container-']").forEach(s=>{var r,n;Array.from(s.classList).forEach(i=>{i.startsWith("characterID-")&&s.classList.remove(i)});let a=(n=(r=s.querySelector(".serihu-char"))==null?void 0:r.textContent)==null?void 0:n.trim();if(!a)return;let e=this.getCharacterID(a);console.log(`Character name: ${a}, Character ID: ${e}`),e?s.classList.add(`characterID-${e}`):console.warn(`No character ID found for: ${a}`)})}getCharacterID(s){var t;return((t=this.plugin.settings.characters.find(a=>a.name===s))==null?void 0:t.id)||null}};var S=class extends P.Plugin{async onload(){console.log("Manga-Dialogue-Render Loaded"),await this.loadSettings(),this.styleManager=new C(this.app,this.settings,this.manifest),this.styleEl=document.createElement("style"),document.head.appendChild(this.styleEl),await L(this.app,this.manifest,this.styleEl),this.styleManager.applyCustomStyles(),this.registerMarkdownCodeBlockProcessor("serihu",(t,a,e)=>{this.dialogueRenderer=new b(this,t,a)}),this.addSettingTab(new y(this.app,this,this.manifest))}onunload(){v(this.app,this.manifest,this.styleManager,!0),document.head.removeChild(this.styleEl)}async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async saveSettings(){await this.saveData(this.settings),await v(this.app,this.manifest,this.styleManager,!1)}};
